#!/usr/bin/ruby

require 'io/console'

require_relative 'tools/catch_exception'
require_relative 'tools/col'
require_relative 'tools/help_print'
require_relative 'tools/options'

version = 'v.1.4.0'
puts "
ooooooooooooo ooooo ooooo        ooooo     ooo ooooooo  ooooo
8    888    8  888   888          888       8    8888    d8
     888       888   888          888       8     Y888..8P
     888       888   888          888       8       8888
     888       888   888          888       8     .8PY888.
     888       888   888       o   88.    .8     d8    888b
    o888o     o888o o888ooooood8     YbodP     o888o  o88888o
".red
print 'version'.white
print " #{version}".light_blue
print ' by Endormi '.white
link = "\e]8;;https://github.com/endormi/tilux\a(github.com/endormi/tilux)\e]8;;\a"
puts link.white

sleep 1

$prompt = "\ntilux~# ".light_yellow

def sys(file)
  system('clear')
  system(file)
end

def c(*args)
  args
end

def _print(choice, option)
  c(empty_input?(choice), sys('clear'), option[choice].call)
  print $prompt.to_s
end

def choices(choice)
  print_cmd = {
    '1'      =>     -> { crypto_print },
    '2'      =>     -> { monitoring_print },
    '3'      =>     -> { net_print },
    '4'      =>     -> { system_print },
    '--help' => lambda {
      help_print
      exit
    }
  }

  begin
    c(_print(choice, print_cmd))
  rescue StandardError
    abort('Incorrect choice!')
  end
end

def nested_choices(nested_choice)
  nested_print_cmd = {
    '-cc'  => -> { cryptography_print },
    '-op'  => -> { cryptography_print },
    '-pc'  => -> { cryptography_print },
    '-zp'  => -> { cryptography_print },
    '-c'   => -> { systemc_print },
    '-f'   => -> { systemf_print },
    '-img' => -> { systemi_print },
    '-i'   => -> { systemin_print },
    '-o'   => -> { systemo_print },
    '-p'   => -> { systemp_print },
    '-s'   => -> { systems_print }
  }

  begin
    c(_print(nested_choice, nested_print_cmd))
  rescue StandardError
    abort('Incorrect choice!')
  end
end

if ARGV.empty?
  puts "\nWhat script do you want to run?\n".white
  tilux_print
  print $prompt.to_s
  input0 = gets.chomp.to_s.downcase.strip
  choices(input0)

  input1 = gets.chomp.to_s.downcase.strip
  has_nested_hash = $opts[:"#{input0}"]&.[](:"#{input1}")

  # Means that it has more nested hashes
  if has_nested_hash.is_a?(Hash)
    nested_choices(input1)
    input2 = gets.chomp.to_s.downcase.strip
    value = $opts.dig(:"#{input0}", :"#{input1}", :"#{input2}")
  else
    value = $opts.dig(:"#{input0}", :"#{input1}")
  end

  begin
    c(value.call)
  rescue StandardError
    abort('Incorrect choice!')
  end

else
  arg0 = ARGV[0].to_s.downcase.strip
  arg1 = ARGV[1].to_s.downcase.strip
  arg2 = ARGV[2].to_s.downcase.strip

  if arg0 == '--help'
    sys('clear')
    help_print
    exit
  end

  value = if arg2.empty?
            $opts.dig(:"#{arg0}", :"#{arg1}")
          else
            $opts.dig(:"#{arg0}", :"#{arg1}", :"#{arg2}")
          end

  begin
    c(value.call)
  rescue StandardError
    abort('Incorrect choice!')
  end

end
